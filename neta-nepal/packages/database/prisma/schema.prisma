generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================
// CORE ENTITIES
// ===========================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // Hashed password (nullable for OAuth users)
  role          UserRole  @default(PUBLIC)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  auditLogs          AuditLog[]
  moderationReviews  ModerationQueue[] @relation("ReviewedBy")
  correctionRequests CorrectionRequest[]
  userActivities     UserActivity[]
  
  @@index([email])
  @@index([role])
}

enum UserRole {
  PUBLIC          // Can view only
  REGISTERED      // Can submit corrections
  MODERATOR       // Can approve/reject submissions
  ADMIN           // Full access
  SUPER_ADMIN     // System administration
}

model Province {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  nameNepali      String?
  code            String   @unique // e.g., "P1", "P2"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  districts       District[]
  constituencies  Constituency[]
  
  @@index([code])
}

model District {
  id              Int      @id @default(autoincrement())
  name            String
  nameNepali      String?
  provinceId      Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  province        Province       @relation(fields: [provinceId], references: [id])
  constituencies  Constituency[]
  
  @@unique([provinceId, name])
  @@index([provinceId])
}

model Constituency {
  id              Int              @id @default(autoincrement())
  name            String
  nameNepali      String?
  constituencyNumber Int?          // For federal constituencies
  level           GovernmentLevel
  provinceId      Int
  districtId      Int?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  province        Province     @relation(fields: [provinceId], references: [id])
  district        District?    @relation(fields: [districtId], references: [id])
  candidates      Candidate[]
  electionResults ElectionResult[]
  
  @@unique([provinceId, districtId, constituencyNumber, level])
  @@index([provinceId])
  @@index([districtId])
  @@index([level])
}

enum GovernmentLevel {
  FEDERAL
  PROVINCIAL
  LOCAL
}

model Party {
  id                    Int       @id @default(autoincrement())
  name                  String    @unique                    // English (translated)
  nameNepali            String?                             // पार्टीको नाम
  shortName             String?                             // Common abbreviation (NC, UML, etc.)
  shortNameNepali       String?
  
  // Registration Details
  registrationNumber    String?   @unique                   // दर्ता नं.
  applicationDateBs     String?                             // निवेदन दर्ता मिति
  applicationDateAd     DateTime?
  registrationDateBs    String?                             // दल दर्ता मिति
  registrationDateAd    DateTime?
  renewalDateBs         String?
  renewalDateAd         DateTime?
  
  // Contact & Location
  headquarters          String?   @db.Text                  // दलको मुख्य कार्यालय ठेगाना
  province              String?                             // Extract from address
  district              String?                             // Extract from address
  contactPhone          String?                             // Could be multiple
  contactEmail          String?
  
  // Leadership
  chairpersonName       String?                             // अध्यक्ष
  chairpersonNameNepali String?
  generalSecretaryName  String?                             // महासचिव
  generalSecretaryNameNepali String?
  
  // Symbol
  symbolName            String?                             // चिन्हको नाम (English)
  symbolNameNepali      String?                             // चिन्हको नाम (Nepali)
  symbolUrl             String?                             // Path to symbol image
  symbolDescription     String?                             // "Tree", "Sun", "Hammer", etc.
  
  // Metadata
  foundedYear           Int?
  website               String?
  ideology              String?                             // "Socialist", "Democratic", etc.
  isActive              Boolean   @default(true)
  isMajorParty          Boolean   @default(false)           // For filtering
  
  // Data Quality
  dataSource            String?                             // "ECN-2080", "Manual", etc.
  verificationStatus    VerificationStatus @default(PENDING)
  verifiedAt            DateTime?
  verifiedBy            String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  candidates            Candidate[]
  electionResults       ElectionResult[]

  @@index([name])
  @@index([nameNepali])
  @@index([isActive])
  @@index([isMajorParty])
  @@index([registrationNumber])
  @@index([verificationStatus])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  NEEDS_REVIEW
  INCORRECT
}

model Candidate {
  id                  String           @id @default(cuid())
  name                String
  nameNepali          String?
  
  // Personal Info
  age                 Int?
  dateOfBirth         DateTime?
  gender              Gender?
  placeOfBirth        String?
  education           String?          @db.Text
  occupation          String?
  
  // Visual & Contact
  photoUrl            String?
  contactEmail        String?
  contactPhone        String?
  residenceAddress    String?          @db.Text
  
  // Social Media
  twitterHandle       String?
  facebookUrl         String?
  instagramHandle     String?
  linkedinUrl         String?
  websiteUrl          String?
  
  // Political Info
  partyId             Int
  constituencyId      Int
  bio                 String?          @db.Text
  yearsInPolitics     Int?
  
  // Computed scores (updated by cron jobs or triggers)
  impactScore         Float?           @default(0)
  scandalScore        Float?           @default(0)
  fulfillmentRate     Float?           @default(0)
  attendance          Float?           @default(0)
  trustScore          Float?           @default(0)
  popularityScore     Int?             @default(0) // Page views
  
  // Status indicators
  status              CandidateStatus  @default(DRAFT)
  isVerified          Boolean          @default(false)
  hasAllegations      Boolean          @default(false)
  hasCriminalCases    Boolean          @default(false)
  
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  publishedAt         DateTime?
  
  // Relations
  party               Party            @relation(fields: [partyId], references: [id])
  constituency        Constituency     @relation(fields: [constituencyId], references: [id])
  
  posts               CandidatePost[]
  promises            Promise[]
  works               Work[]
  cases               Case[]
  rumors              Rumor[]
  financialDisclosures FinancialDisclosure[]
  electionResults     ElectionResult[]
  mediaMentions       MediaMention[]
  relations           CandidateRelation[] @relation("CandidateRelations")
  relatedTo           CandidateRelation[] @relation("RelatedCandidates")
  comparisons         Comparison[]     @relation("ComparedCandidates")
  auditLogs           AuditLog[]
  
  @@index([partyId])
  @@index([constituencyId])
  @@index([status])
  @@index([name])
  @@index([impactScore])
  @@index([scandalScore])
  @@index([fulfillmentRate])
  @@index([twitterHandle])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CandidateStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  ARCHIVED
}

model CandidatePost {
  id              Int          @id @default(autoincrement())
  candidateId     String
  position        String       // e.g., "Minister of Finance", "Mayor of Kathmandu"
  positionNepali  String?
  positionType    PositionType? // Link to the standardized position types
  level           GovernmentLevel
  startDate       DateTime
  endDate         DateTime?
  isCurrent       Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  candidate       Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  @@index([candidateId])
  @@index([isCurrent])
  @@index([level])
  @@index([positionType])
}

// ===========================
// CONTENT ENTITIES
// ===========================

model Promise {
  id              String          @id @default(cuid())
  candidateId     String
  text            String          @db.Text
  category        PromiseCategory
  type            PromiseType
  status          PromiseStatus   @default(NO_EVIDENCE)
  electionCycle   String?         // e.g., "2022", "2017"
  progressPercent Int?            @default(0) // 0-100
  announcedDate   DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  candidate       Candidate       @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  sources         PromiseSource[]
  
  @@index([candidateId])
  @@index([category])
  @@index([status])
}

enum PromiseCategory {
  ECONOMY
  INFRASTRUCTURE
  HEALTH
  EDUCATION
  SOCIAL_WELFARE
  ENVIRONMENT
  GOVERNANCE
  SECURITY
  AGRICULTURE
  OTHER
}

enum PromiseType {
  MANIFESTO
  SPEECH
  PUBLIC_COMMITMENT
  INTERVIEW
  OTHER
}

enum PromiseStatus {
  KEPT
  IN_PROGRESS
  BROKEN
  NO_EVIDENCE
  PARTIALLY_FULFILLED
}

model Work {
  id              String       @id @default(cuid())
  candidateId     String
  title           String
  titleNepali     String?
  description     String       @db.Text
  category        WorkCategory
  impactLevel     ImpactLevel  @default(MEDIUM)
  startDate       DateTime
  endDate         DateTime?
  completionPercent Int?       @default(0) // 0-100
  budget          Decimal?     @db.Decimal(15, 2)
  beneficiaries   Int?
  location        String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  candidate       Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  sources         WorkSource[]
  
  @@index([candidateId])
  @@index([category])
  @@index([impactLevel])
}

enum WorkCategory {
  INFRASTRUCTURE
  HEALTH
  EDUCATION
  SOCIAL_PROGRAMS
  POLICY_WORK
  LEGISLATION
  COMMUNITY_DEVELOPMENT
  ENVIRONMENT
  OTHER
}

enum ImpactLevel {
  LOW
  MEDIUM
  HIGH
}

model Case {
  id              String       @id @default(cuid())
  candidateId     String
  allegation      String       @db.Text
  caseNumber      String?
  courtName       String?
  severity        Int          @default(3) // 1-5 scale
  status          CaseStatus   @default(FILED)
  filedDate       DateTime?
  closedDate      DateTime?
  verdict         String?      @db.Text
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  candidate       Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  sources         CaseSource[]
  
  @@index([candidateId])
  @@index([status])
  @@index([severity])
}

enum CaseStatus {
  FILED
  UNDER_INVESTIGATION
  TRIAL
  HEARING
  ACQUITTED
  CONVICTED
  WITHDRAWN
  CLOSED
  INACTIVE
}

model Rumor {
  id              String       @id @default(cuid())
  candidateId     String
  text            String       @db.Text
  sourceType      RumorSource
  originDate      DateTime
  expiryDate      DateTime     // Auto-calculated (originDate + 60 days)
  popularityCount Int          @default(0) // # of mentions tracked
  isExpired       Boolean      @default(false)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  candidate       Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  @@index([candidateId])
  @@index([isExpired])
  @@index([expiryDate])
}

enum RumorSource {
  SOCIAL_MEDIA
  SPEECH
  HEARSAY
  UNVERIFIED_MEDIA
  OTHER
}

// ===========================
// SOURCES & VERIFICATION
// ===========================

model Source {
  id              String           @id @default(cuid())
  title           String
  publisher       String
  url             String           @db.Text
  archivedUrl     String?          @db.Text
  publishedDate   DateTime?
  accessedAt      DateTime?        // When we last verified the link
  reliabilityTier SourceTier
  isArchived      Boolean          @default(false)
  archiveStatus   ArchiveStatus    @default(NOT_ARCHIVED)
  language        String?          // "en", "ne"
  mediaType       MediaType        @default(ARTICLE)
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  promiseSources  PromiseSource[]
  workSources     WorkSource[]
  caseSources     CaseSource[]
  mediaMentions   MediaMention[]
  
  @@index([reliabilityTier])
  @@index([mediaType])
}

enum SourceTier {
  TIER_1_OFFICIAL       // Election Commission, Courts, Govt docs
  TIER_2_REPUTABLE      // National media (Kantipur, BBC Nepali, etc.)
  TIER_3_LOCAL          // Local/regional outlets
  TIER_4_SOCIAL         // Social media, public statements
}

enum ArchiveStatus {
  NOT_ARCHIVED
  ARCHIVED
  ARCHIVE_FAILED
  ARCHIVE_PENDING
}

enum MediaType {
  ARTICLE
  VIDEO
  AUDIO
  DOCUMENT
  IMAGE
  SOCIAL_POST
}

// Junction tables for many-to-many relationships
model PromiseSource {
  promiseId   String
  sourceId    String
  createdAt   DateTime @default(now())
  
  promise     Promise  @relation(fields: [promiseId], references: [id], onDelete: Cascade)
  source      Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  @@id([promiseId, sourceId])
  @@index([promiseId])
  @@index([sourceId])
}

model WorkSource {
  workId      String
  sourceId    String
  createdAt   DateTime @default(now())
  
  work        Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  source      Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  @@id([workId, sourceId])
  @@index([workId])
  @@index([sourceId])
}

model CaseSource {
  caseId      String
  sourceId    String
  createdAt   DateTime @default(now())
  
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  source      Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  @@id([caseId, sourceId])
  @@index([caseId])
  @@index([sourceId])
}

// ===========================
// FEATURES: COMPARE, RANKINGS
// ===========================

model Comparison {
  id              String     @id @default(cuid())
  userId          String?    // Optional: track comparisons by user
  candidateIds    String[]   // Array of candidate IDs (max 3)
  createdAt       DateTime   @default(now())
  
  candidates      Candidate[] @relation("ComparedCandidates")
  
  @@index([userId])
}

model Ranking {
  id              String         @id @default(cuid())
  category        RankingCategory
  candidateId     String
  rank            Int
  score           Float
  calculatedAt    DateTime       @default(now())
  
  @@unique([category, calculatedAt, candidateId])
  @@index([category])
  @@index([calculatedAt])
}

enum RankingCategory {
  TOP_IMPACT
  CLEANEST_RECORDS
  HIGHEST_FULFILLMENT
  MOST_EXPERIENCED
  MOST_POPULAR
  MOST_IMPROVED
}

// ===========================
// NEW MODELS: TRANSPARENCY & ACCOUNTABILITY
// ===========================

model FinancialDisclosure {
  id              String    @id @default(cuid())
  candidateId     String
  year            Int
  assets          Decimal?  @db.Decimal(15, 2)
  liabilities     Decimal?  @db.Decimal(15, 2)
  income          Decimal?  @db.Decimal(15, 2)
  declarationUrl  String?   @db.Text
  isVerified      Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  @@unique([candidateId, year])
  @@index([candidateId])
  @@index([year])
}

model ElectionResult {
  id              String       @id @default(cuid())
  candidateId     String
  electionYear    Int
  electionType    ElectionType
  positionType    PositionType // NEW: The actual position contested for
  constituencyId  Int
  partyId         Int
  votesReceived   Int?
  totalVotes      Int?
  rank            Int?
  isWinner        Boolean      @default(false)
  
  createdAt       DateTime     @default(now())
  
  candidate       Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  constituency    Constituency @relation(fields: [constituencyId], references: [id])
  party           Party        @relation(fields: [partyId], references: [id])
  
  @@unique([candidateId, electionYear, constituencyId, positionType])
  @@index([candidateId])
  @@index([electionYear])
  @@index([isWinner])
  @@index([positionType])
}

enum ElectionType {
  FEDERAL_FPTP          // Direct election for House of Representatives
  FEDERAL_PR            // Proportional Representation for HoR
  PROVINCIAL_FPTP       // Direct election for Provincial Assembly
  PROVINCIAL_PR         // Proportional Representation for PA
  LOCAL_DIRECT          // Direct election for local positions
}

enum PositionType {
  // Federal Level
  MEMBER_OF_PARLIAMENT      // सांसद (House of Representatives - FPTP)
  MP_PROPORTIONAL          // प्रतिनिधि सभा सदस्य (PR)
  
  // Provincial Level  
  PROVINCIAL_ASSEMBLY_MEMBER    // प्रदेश सभा सदस्य (FPTP)
  PA_PROPORTIONAL              // प्रदेश सभा सदस्य (PR)
  
  // Local Level - Metropolitan City (महानगरपालिका)
  METROPOLITAN_MAYOR           // महानगर प्रमुख
  METROPOLITAN_DEPUTY_MAYOR    // महानगर उपप्रमुख
  METROPOLITAN_WARD_CHAIR      // वडा अध्यक्ष
  METROPOLITAN_WARD_MEMBER     // वडा सदस्य
  
  // Local Level - Sub-Metropolitan City (उपमहानगरपालिका)
  SUB_METROPOLITAN_MAYOR       // उपमहानगर प्रमुख
  SUB_METROPOLITAN_DEPUTY_MAYOR // उपमहानगर उपप्रमुख
  SUB_METROPOLITAN_WARD_CHAIR  // वडा अध्यक्ष
  SUB_METROPOLITAN_WARD_MEMBER // वडा सदस्य
  
  // Local Level - Municipality (नगरपालिका)
  MUNICIPAL_MAYOR              // नगर प्रमुख
  MUNICIPAL_DEPUTY_MAYOR       // नगर उपप्रमुख
  MUNICIPAL_WARD_CHAIR         // वडा अध्यक्ष
  MUNICIPAL_WARD_MEMBER        // वडा सदस्य
  
  // Local Level - Rural Municipality (गाउँपालिका)
  RURAL_MUNICIPAL_CHAIR        // गाउँपालिका अध्यक्ष
  RURAL_MUNICIPAL_VICE_CHAIR   // गाउँपालिका उपाध्यक्ष
  RURAL_WARD_CHAIR            // वडा अध्यक्ष
  RURAL_WARD_MEMBER           // वडा सदस्य
}

model MediaMention {
  id              String          @id @default(cuid())
  candidateId     String
  title           String
  sourceId        String
  publishedDate   DateTime
  sentiment       Sentiment       @default(NEUTRAL)
  category        MentionCategory
  excerptText     String?         @db.Text
  
  createdAt       DateTime        @default(now())
  
  candidate       Candidate       @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  source          Source          @relation(fields: [sourceId], references: [id])
  
  @@index([candidateId])
  @@index([publishedDate])
  @@index([sentiment])
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum MentionCategory {
  ACHIEVEMENT
  CONTROVERSY
  POLICY
  PERSONAL
  OTHER
}

model CandidateRelation {
  id                 String       @id @default(cuid())
  candidateId        String
  relatedName        String
  relationship       RelationType
  details            String?      @db.Text
  isPublicFigure     Boolean      @default(false)
  relatedCandidateId String?
  
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  
  candidate          Candidate    @relation("CandidateRelations", fields: [candidateId], references: [id], onDelete: Cascade)
  relatedCandidate   Candidate?   @relation("RelatedCandidates", fields: [relatedCandidateId], references: [id])
  
  @@index([candidateId])
  @@index([relatedCandidateId])
}

enum RelationType {
  SPOUSE
  PARENT
  CHILD
  SIBLING
  BUSINESS_PARTNER
  POLITICAL_ALLY
  OTHER
}

model UserActivity {
  id              String       @id @default(cuid())
  userId          String?      // Null for anonymous
  sessionId       String?
  activityType    ActivityType
  targetType      String?      // "Candidate", "Promise", etc.
  targetId        String?
  metadata        Json?
  
  createdAt       DateTime     @default(now())
  
  user            User?        @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
  @@index([targetType, targetId])
}

enum ActivityType {
  VIEW_PROFILE
  VIEW_PROMISE
  VIEW_WORK
  COMPARE_CANDIDATES
  SEARCH
  SHARE
  REPORT_ERROR
  UPVOTE
  DOWNVOTE
}

// ===========================
// MODERATION & GOVERNANCE
// ===========================

model ModerationQueue {
  id              String            @id @default(cuid())
  entityType      ModerationEntity
  entityId        String
  submittedBy     String?           // User ID
  status          ModerationStatus  @default(PENDING)
  reviewedBy      String?           // User ID
  reviewNotes     String?           @db.Text
  changesDiff     Json?             // Store original vs new as JSON
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  reviewedAt      DateTime?
  
  reviewer        User?             @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  
  @@index([status])
  @@index([entityType])
  @@index([submittedBy])
  @@index([reviewedBy])
}

enum ModerationEntity {
  CANDIDATE
  PROMISE
  WORK
  CASE
  RUMOR
  SOURCE
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_CHANGES
}

model CorrectionRequest {
  id              String    @id @default(cuid())
  candidateId     String?
  entityType      String?   // "promise", "work", "case", etc.
  entityId        String?
  submitterName   String?
  submitterEmail  String?
  submitterId     String?   // If logged in
  description     String    @db.Text
  suggestedSource String?   @db.Text
  status          CorrectionStatus @default(SUBMITTED)
  adminNotes      String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  resolvedAt      DateTime?
  
  submitter       User?     @relation(fields: [submitterId], references: [id])
  
  @@index([status])
  @@index([candidateId])
}

enum CorrectionStatus {
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  REQUIRES_INFO
}

model AuditLog {
  id              String    @id @default(cuid())
  userId          String
  action          String    // "CREATE", "UPDATE", "DELETE", "APPROVE", "REJECT"
  entityType      String    // "Candidate", "Promise", "Work", etc.
  entityId        String
  changes         Json?     // Store before/after as JSON
  reason          String?   @db.Text
  ipAddress       String?
  
  createdAt       DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id])
  candidate       Candidate? @relation(fields: [entityId], references: [id])
  
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
}
